{% load static %}
<html>
    <head>
	<title>Profile Data Browser - xCITE Data Lab</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- leaflet stuff -->
	<link rel="stylesheet" href="//unpkg.com/leaflet@1.1.0/dist/leaflet.css" integrity="sha512-wcw6ts8Anuw10Mzh9Ytw4pylW8+NAD4ch3lqm9lzAsTxg0GFeJgoAtxuCLREZSC5lUXdVyo/7yfsqFjQ4S+aKw==" crossorigin="">
	<script src="//unpkg.com/leaflet@1.1.0/dist/leaflet.js" integrity="sha512-mNqn2Wg7tSToJhvHcqfzLMU6J4mkOImSPTxVZAdo+lcPlk+GhZmYgACEe0x35K7YzW1zJ7XyJV/TT1MrdXvMcA==" crossorigin=""></script>
	<!-- jquery stuff -->
	<script src="//code.jquery.com/jquery-3.2.1.min.js"></script>
	<!-- spinning stuff -->
	<script src="//cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"></script>
	<!-- for the bootstrap timepicker -->
	<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.1/moment.min.js"></script>
	<!-- <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script> -->
	<!-- <script type="text/javascript" src="//cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script> -->
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css">
	<!-- alpaca -->
        <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>
        <link rel="stylesheet" href="//code.cloudcms.com/alpaca/1.5.23/bootstrap/alpaca.min.css" rel="stylesheet" />
        <script src="//code.cloudcms.com/alpaca/1.5.23/bootstrap/alpaca.min.js"></script>
	<!-- Include Date Range Picker -->
	<script type="text/javascript" src="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.js"></script>
	<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />
	<!-- the site-wide css file -->
	<link rel="stylesheet" href="{% static 'css/main.css' %}">
	<!-- some extra tools for alpaca -->
	<script type="text/javascript" src="{% static 'js/alpaca-extra.js' %}"></script>
	<!-- a bit of styling -->
	<style>
	 /* ... will I put stuff in here? Maybe. */
	 #lidar_graph {
	     min-height: 350px;
	 }
	 .alpaca-control {
	     width: auto;
	 }
	 label.control-label::after {
	     content: ':';
	 }
	 /* .help-block {
	    display: inline;
	    margin-left: 5px;
	    } */
	 /* range field styling */
	 .alpaca-field-range .alpaca-container-item,
	 .alpaca-field-range .form-group,
	 .alpaca-field-range input {
	     display: inline;
	 }
	 .alpaca-field-range .alpaca-container-item label.control-label {
	     font-weight: normal;
	 }
	 .alpaca-field-range .alpaca-container-item label.control-label::after {
	     content: none;
	 }
	 /* time range styling */
	 .alpaca-field-daterange input {
	     min-width: 260px;
	 }
	 /* wide layout formatting */
	 .alpaca-wide .alpaca-layout-binding-holder {
	     display: inline-block;
	     margin-right: 10px;
	 }
	 #left.col-md-6, #right.col-md-6 {
	     min-width: 355px;
	     width: fit-content;
	     float: left;
	 }
	 /* fix the buttons */
	 .alpaca-form-buttons-container {
	     text-align: left;
	     margin: 10px;
	 }
	 /* make the map work right */
	 .alpaca-field-leaflet-select select {
	     margin-bottom: 5px;
	 }
	 .alpaca-form-leaflet-select-map {
	     height: 200px;
	     width: 250px;
	     border: 1px solid gray;
	     /* float: right; */
	     margin-right: 4px;
	     /* margin-top: 5px; */
	 }
	</style>
    </head>
    <body>
	<div id="height">
	    {% include 'header.html' %}
	    <div id="form"></div>
	    <script type="text/javascript">
	     /* setting up some alpaca options */
	     var drpicker_options = {
		 timePicker: true,
		 timePicker24Hour: true,
		 timePickerIncrement: 5,
		 showDropdowns: true,
		 locale: {
		     format: 'MM/DD/YYYY HH:mm'
		 },
		 opens: 'left'
	     };
	     var var_options = {
		 'cnr': 'CNR',
		 'drws': 'DRWS',
		 'barbs': 'Wind Direction',
		 'hwind': 'Horizontal Wind Speed',
		 'zwind': 'Vertical Wind Speed',
		 'xwind': 'x Wind Speed',
		 'ywind': 'y Wind Speed',
		 'temp': 'Temperature',
		 'vapor': 'Vapor Density',
		 'liquid': 'Liquid',
		 'rh': 'Relative Humidity'
	     };
	     var map_options = {zoomControl: false,
				maxZoom: 16};
	     var marker_options = {radius: 6, color: 'blue', weight: 0,
				   opacity: .8, fillOpacity: .8};
	     var selected_marker_options = {color: 'orange'};
	     /* creating the form */
	     $(document).ready(function() {
                 $("#form").alpaca({
		     schema: {
                         title: "Data Options",
                         type: "object",
                         properties: {
			     dr: {
				 title: 'Time range (UTC)',
				 type: 'string'
			     },
			     var: {
                                 type: 'string',
                                 title: 'Data',
				 default: 'cnr'
			     },
			     sources: {
                                 type: 'string',
                                 title: 'Sources'
			     },
			     sites: {
                                 type: 'string',
                                 title: 'Sites'
			     },
			     barb: {
				 title: 'Overlays'
			     },
			     pbl: {
			     }
                         }
		     },
		     options: {
			 focus: false,
			 form: {
			     attributes: {
                                 action: 'javascript:update_graphs();'
			     },
			     buttons:{
                                 submit: {
				     title: 'View Data'
				 }
			     }
                         },
                         fields: {
			     dr: {
				 placeholder: 'Loading...',
				 type: 'daterange',
				 picker: drpicker_options
			     },
			     var: {
                                 type: 'select',
				 dataSource: var_options,
				 removeDefaultNone: true,
				 sort: false,
				 helper: "<a href=\"{% url 'datasets' %}\" target=\"_blank\">see data definitions</a>"
			     },
			     sources: {
                                 type: "select",
				 multiple: true,
				 removeDefaultNone: true
			     },
			     sites: {
                                 type: "leaflet-select",
				 removeDefaultNone: true,
				 multiple: true,
				 map_options: map_options,
				 /* markerFunction: L.marker,*/
				 marker: marker_options,
				 selectedMarker: selected_marker_options,
				 /* hideSelect: true*/
			     },
			     barb: {
				 type: 'checkbox',
				 rightLabel: 'Wind barbs (DBS mode only)'
			     },
			     pbl: {
				 type: 'checkbox',
				 rightLabel: 'PBL/Residual Layer (Experimental)',
				 /* hidden: true*/
			     }
                         }
		     },
		     view: {
			 parent: "bootstrap-edit-extra",
			 layout: {
			     template: "{% static 'profiles/html/form.html' %}",
			     bindings: {
				 var: 'left',
				 dr: 'right',
				 sources: 'left',
				 sites: 'right',
				 barb: 'left',
				 pbl: 'left'
			     }
			 }
		     },
		     postRender: function(control) {
			 /* is there a graph already? */
			 var has_graph = false;
			 
			 /* get the map div ID so we can add a spinner */
			 var map_div_id = 'map-' + control.childrenByPropertyId['sites'].id;

			 /* update the map when the data sources change */
			 var sources = $(control.childrenByPropertyId['sources'].control);
			 /* sources.on('change', update_map);*/
			 control.childrenByPropertyId['sources'].on('change', update_map);

			 /* make needed changes when selected var changes */
			 var dataset = $(control.childrenByPropertyId['var'].control);
			 dataset.on('change', update_var);

			 /* update sources when sites change */
			 var sites = control.childrenByPropertyId['sites'];
			 sites.on('change', markerClick);

			 update_lidar_scans = function() {
			     /* updating the lidar select dropdown list */
			     var v = control.childrenByPropertyId['var'].getValue();
			     /* can't add wind barbs to radiometer data at the moment
				so don't allow that */
			     /* if (instrument == 'mwr') {
				barbbox.prop('checked', false);
				barbbox.prop('disabled', true);
				} else {
				barbbox.prop('disabled', false);
				};*/
			     /* disable all the options while we update them, and add
				spinner to the map */
			     var options = $(sources[0].options);
			     options.each(function(i, option) {
				 option.disabled = true;
			     });
			     spinner.spin();
			     $('#' + map_div_id).append(spinner.el);
			     /* get available scans and make new list */
			     /* keep track of the sites-- try to keep these sites
				selected when updating the choices */
			     var selected_sites = [];
			     $.each(sources[0].options, function(i, option) {
				 if (option.value != '') {
				     var site = lidars[i]['site_name'];
				     if (option.selected & (selected_sites.indexOf(site) == -1)) {
					 selected_sites.push(site);
				     };
				 };
			     });
			     return get_lidar_scans().done(function(lidars_api) {
				 lidars = lidars_api;
				 var arr = [];
				 var sites_data = [];
				 var site_locations = {};
				 $.each(lidars, function(i, lidar) {
				     var value = String(i);
				     arr.push({value: value,
					       text: lidar['lidar_name'] + ' (' + lidar['scan_name'] + ')'});
				     var site_name = lidar['site_name'];
				     if (sites_data.indexOf(site_name) == -1) {
					 sites_data.push(site_name);
					 var latlng = [lidar['latitude'], lidar['longitude']];
					 site_locations[site_name] = latlng;
				     };
				 });
				 var sel = sources;
				 /* change the selectlist options via alpaca */
				 var sources2 = control.childrenByPropertyId['sources'];
				 sources2.options.dataSource = arr;
				 sources2.refresh();
				 /* disable some options if needed (for wind datasets) */
				 disable_options();

				 /* change the available sites */
				 var sites = control.childrenByPropertyId['sites'];
				 sites.options.dataSource = sites_data;
				 sites.options.locations = site_locations;
				 sites.refresh();
				 /* $.each(sites.markers.getLayers(), function(i, marker) {
				    marker.on('click', markerClick);
				    });*/
				 
				 /* update_map();*/
				 spinner.stop();

				 // get a graph if there isn't one
				 if (!has_graph) {
				     sel.val(['0']);
				     sel.change();
				     update_graphs();
				     has_graph = true;
				 }
			     });
			 };

			 /* change the data sources when the date range changes */
			 var dr = control.childrenByPropertyId['dr'];
			 var drp = dr.control.data('daterangepicker');
			 dr.on('change', update_lidar_scans);

			 /* print an error message when the graph fails to load */
			 graph.on('error', function(ev) {
			     try {
				 spinner.stop();
			     } catch(err) {};
			     graph.css('opacity', 1);
			     graph.attr('alt', 'Error: failed to get the image');
			 });

			 /* get the max and min times for the datetime
			    fields, and set them to default values */
			 get_date_range().done(function(result) {
			     /* make sure to clone to avoid
				accidentally changing the
				daterangeicker times in other
				functions!! Use 'clone' to modify the
				times! */

			     var min_date = moment(result[0]);
			     var cur_date = moment(result[1]);
			     var max_date = cur_date.clone().add(1, 'd');
			     drp.minDate = min_date;
			     drp.maxDate = max_date;
			     drp.setStartDate(cur_date);
			     /* Starting the autoupdate here so it
				only updates once when the page loads! */
			     drp.autoUpdateInput = true;
			     drp.setEndDate(max_date);
			 });
		     }
		 });
	     });
            </script>
	    <img id="lidar_graph" src="" alt="Results">
	    <script type="text/javascript">
	     /* a few useful variables */
	     var graph = $('#lidar_graph');
	     var selected_sites = [];
	     var instrument = 'lidar';
	     var mwr_data = ['temp', 'vapor', 'liquid', 'rh'];
	     /* the data variables that depend on wind information */
	     var requires_wind = ['barbs', 'hwind', 'zwind', 'xwind', 'ywind'];
	     /* keeping track of the changes to the selected sites */
	     var old_sites = [];
	     var spinner = new Spinner();
	     graph.on('load', function() {
		 try {
		     spinner.stop();
		 } catch(err) {};
		 graph.css('opacity', 1);
	     });
	     /* this variable stores information about the selected
		lidar/scan combinations */
	     var lidars;
	     var get_date_range = function() {
		 return $.getJSON("{% url 'date_range' %}");
	     };
	     var get_lidar_scans = function(v) {
		 var form1 = $('#form').alpaca('get');
		 var v = form1.childrenByPropertyId['var'].getValue();
		 var dr = form1.childrenByPropertyId['dr'];
		 var drp = dr.control.data('daterangepicker');
		 var min_time = drp.startDate.format('YYYY-MM-DDTHH:mm:ss.SSS[Z]');
		 var max_time = drp.endDate.format('YYYY-MM-DDTHH:mm:ss.SSS[Z]');
		 var url = "{% url 'available_scans' %}?time_min=" +
			   min_time + '&time_max=' +
			   max_time + '&var=' + v;
		 return $.getJSON(url);
	     };
	     var update_graphs = function() {
		 var form = $('#form').alpaca('get');
		 var sources = form.childrenByPropertyId['sources'].getValue();
		 var var_str = form.childrenByPropertyId['var'].getValue();
		 var dr = $(form.childrenByPropertyId['dr'].control).data('daterangepicker');
		 /* the start and end dates are stored in the local
		    time zone instead of UTC. Rather than converting it,
		    I'm just printing out the local time and pretending
		    it's UTC */
		 var min_time = dr.startDate.format('YYYY-MM-DDTHH:mm:ss.SSS[Z]');
		 var max_time = dr.endDate.format('YYYY-MM-DDTHH:mm:ss.SSS[Z]');
		 var barbs = form.childrenByPropertyId['barb'].getValue();
		 var pbl = form.childrenByPropertyId['pbl'].getValue();
		 /* stop if no sources selected */
		 if (sources.length == 0) {
		     return
		 }
		 var scan_ids = [];
		 $.each(sources, function(i0, index) {
		     var i2 = parseInt(index);
		     scan_ids.push(lidars[i2]['scan_id']);
		 });
		 'appsvr.asrc.cestm.albany.edu:9090/plot?lidar_id=12&scan_id=14&time_min=2016-11-21 00:00&time_max=2016-11-22 00:00&var=CNR&type=heat'
		 var url = "{% url 'plot' %}?scan_id=" +
			   scan_ids.join() + '&time_min=' +
			   min_time + '&time_max=' +
			   max_time + '&var=' +
			   var_str + '&type=heat';
		 if (barbs) {
		     url += '&barbs=True';
		 };
		 if (pbl) {
		     url += '&pbl=True';
		 };
		 spinner.spin();
		 graph.css('opacity', .4);
		 $('body').append(spinner.el);
		 graph.attr("src", url);
	     };
	     var disable_options = function() {
		 var form = $('#form').alpaca('get');
		 var sources = $(form.childrenByPropertyId['sources'].control)[0];
		 /* var var_str = form.childrenByPropertyId['var'].getValue();*/
		 var var_str = $(form.childrenByPropertyId['var'].control).val();
		 var options = $(sources.options);
		 var var_requires_wind = requires_wind.indexOf(var_str) != -1;
		 /* var barbs_selected = barbbox.is(":checked");*/
		 if (var_requires_wind) {
		     /* disable the invalid choices */
		     options.each(function(i, option) {
			 /* disable if mode is not DBS */
			 var mode = lidars[i]['mode'];
			 if (mode != 'dbs') {
			     option.disabled = true;
			 };
		     });
		 } else {
		     /* none should be disabled */
		     options.each(function(i, option) {
			 /* disable if mode is not DBS */
			 option.disabled = false;
		     });
		 };
	     };
	     var update_map = function() {
		 var selected_sites = [];
		 /* get all the selected sites */
		 var form1 = $('#form').alpaca('get');
		 var sources = form1.childrenByPropertyId['sources'];
		 /* get unique selected sites */
		 var selected_sources = sources.getValue();
		 $.each(selected_sources, function(i, n) {
		     var site = lidars[parseInt(n)]['site_name'];
		     if (selected_sites.indexOf(site) == -1) {
			 selected_sites.push(site);
		     };
		 });
		 var sites = form1.childrenByPropertyId['sites'];
		 sites.setValue(selected_sites);
		 /* to keep track of changes */
		 old_sites = selected_sites;
	     };
	     function update_var() {
		 disable_options();
		 // are we looking at lidar or mwr data?
		 var form = $('#form').alpaca('get');
		 var v = form.childrenByPropertyId['var'].getValue();
		 var var_instr = (mwr_data.indexOf(v) != -1) ? 'mwr' : 'lidar';
		 if (var_instr == instrument) {
		     // not going to update the choices in this case
		     return $.when();
		 } else {
		     instrument = var_instr;
		     update_lidar_scans();
		 };
	     };
	     var update_sources = function() {
		 /* get all the selected sites */
		 var form1 = $('#form').alpaca('get');
		 var sources = form1.childrenByPropertyId['sources'];
		 var sites = form1.childrenByPropertyId['sites'];
		 var selected_sites = sites.getValue();
		 /* get the deselected sites */
		 
		 /* get unique selected sites */
		 var selected_sources = sources.getValue();
		 $.each(selected_sources, function(i, n) {
		     var site = lidars[parseInt(n)]['site_name'];
		     if (selected_sites.indexOf(site) == -1) {
			 selected_sites.push(site);
		     };
		 });
		 var sites = form1.childrenByPropertyId['sites'];
		 sites.setValue(selected_sites);
	     };
	     function siteSelect(site) {
		 /* update the selected sources in response to
		    selecting a site-- I'd rather do this via alpaca
		    somehow but it absolutely must be done in response
		    to clicking */
		 var form1 = $('#form').alpaca('get');
		 var sources = form1.childrenByPropertyId['sources'];
		 var selected_sources = sources.getValue();
		 var sites = form1.childrenByPropertyId['sites'];
		 var selected_sites = sites.getValue();
		 /* first remove any sources that need to be removed */
		 var new_selected_sources = [];
		 $.each(selected_sources, function(i, source) {
		     if (selected_sites.indexOf(lidars[parseInt(source)]['site_name']) != -1) {
			 new_selected_sources.push(source);
		     };
		 });
		 $.each(lidars, function(i, lidar) {
		     if (lidar['site_name'] == site && selected_sources.indexOf(String(i)) == -1) {
			 new_selected_sources.push(String(i));
		     };
		 });
		 sources.setValue(new_selected_sources);
	     };
	     function siteDeselect(site) {
		 /* update the selected sources in response to
		    deselecting a site-- I'd rather do this via alpaca
		    somehow but it absolutely must be done in response
		    to clicking */
		 var form1 = $('#form').alpaca('get');
		 var sources = form1.childrenByPropertyId['sources'];
		 var selected_sources = sources.getValue();
		 var new_selected_sources = [];
		 $.each(selected_sources, function(i, source) {
		     if (lidars[parseInt(source)]['site_name'] != site) {
			 new_selected_sources.push(source);
		     };
		 });
		 sources.setValue(new_selected_sources);
	     };
	     function markerClick() {
		 var form1 = $('#form').alpaca('get');
		 var sites = form1.childrenByPropertyId['sites'];
		 var new_sites = sites.getValue();
		 $.each(old_sites, function(i, old_site) {
		     if (new_sites.indexOf(old_site) == -1) {
			 /* site was removed */
			 siteDeselect(old_site);
		     };
		 });
		 $.each(new_sites, function(i, new_site) {
		     if (old_sites.indexOf(new_site) == -1) {
			 /* site was added */
			 siteSelect(new_site);
		     };
		 });
		 old_sites = selected_sites;
	     };
	    </script>
	</div>
	{% include 'footer.html' %}
    </body>
</html>
